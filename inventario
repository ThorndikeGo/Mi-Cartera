<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario QA - Driscoll's</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --bg-login: #193e5f; 
            --bg-app: #20507b;
            --driscolls-indigo: #3F51B5;
            --card-active: #2a6191;
            --accent-lavender: #e0e7ff;
            --ok-color: #4ade80;
            --crit-color: #fb7185;
            --low-color: #fbbf24;
        }
        body { background-color: var(--bg-login); color: var(--accent-lavender); font-family: 'Segoe UI', sans-serif; transition: background-color 0.5s ease; }
        body.app-mode { background-color: var(--bg-app); }
        .card { background-color: var(--card-active); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .status-ok { border-left: 5px solid var(--ok-color); }
        .status-low { border-left: 5px solid var(--low-color); }
        .status-crit { border-left: 5px solid var(--crit-color); }
        .input-qa { background-color: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; width: 100%; outline: none; }
        .filter-btn { padding: 8px 14px; border-radius: 10px; font-size: 11px; font-weight: bold; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #a5b4fc; }
        .filter-active { background: var(--driscolls-indigo); color: white; border-color: #5c6bc0; }
        .btn-indigo { background-color: var(--driscolls-indigo); color: white; font-weight: bold; transition: all 0.2s; }
        .btn-indigo:active { transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 pb-24">

    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-8 bg-[#193e5f]">
        <div class="mb-10 text-center fade-in">
            <h1 class="text-4xl font-black text-white uppercase italic">Inventario <span style="color: var(--driscolls-indigo)">QA</span></h1>
            <p class="text-[10px] text-indigo-200 tracking-[0.3em] font-bold mt-1 uppercase">Driscoll's Quality Assurance</p>
            <div class="h-1 w-16 bg-[#3F51B5] mx-auto mt-4 rounded-full"></div>
        </div>
        <div class="w-full max-w-sm space-y-5 fade-in">
            <select id="user-select" class="input-qa text-lg font-semibold"></select>
            <div id="admin-pass-container" class="hidden">
                <input type="password" id="admin-pass" class="input-qa text-2xl tracking-[0.3em]" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button onclick="login()" class="w-full btn-indigo py-4 rounded-2xl font-bold text-xl shadow-2xl">Acceder</button>
        </div>
    </div>

    <div id="app-content" class="hidden max-w-md mx-auto fade-in">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h2 id="current-user-display" class="text-2xl font-black text-white italic uppercase"></h2>
                <p class="text-[9px] text-indigo-200 font-bold tracking-widest uppercase">QA Driscoll's - Cooler</p>
            </div>
            <button onclick="location.reload()" class="text-[9px] border border-white/20 px-3 py-2 rounded-lg font-bold">SALIR</button>
        </header>

        <div id="search-section" class="mb-6 space-y-3">
            <input type="text" id="search-bar" oninput="renderItems()" placeholder="ðŸ” Buscar artÃ­culo o ID..." class="input-qa border-none">
            <div class="flex gap-2 overflow-x-auto pb-1">
                <button onclick="setFilter('all')" id="filter-all" class="filter-btn filter-active">Todos</button>
                <button onclick="setFilter('crit')" id="filter-crit" class="filter-btn">ðŸ”´ CrÃ­tico</button>
                <button onclick="setFilter('low')" id="filter-low" class="filter-btn">ðŸŸ¡ Bajo</button>
                <button onclick="setFilter('ok')" id="filter-ok" class="filter-btn">ðŸŸ¢ OK</button>
            </div>
        </div>

        <div class="flex space-x-1 mb-6 bg-black/20 p-1.5 rounded-2xl">
            <button onclick="switchTab('insumos')" id="tab-insumos" class="flex-1 py-3 rounded-xl font-bold text-[10px]">INSUMOS</button>
            <button onclick="switchTab('equipos')" id="tab-equipos" class="flex-1 py-3 rounded-xl font-bold text-[10px]">EQUIPOS</button>
            <button onclick="switchTab('admin')" id="tab-admin" class="flex-1 py-3 rounded-xl font-bold text-[10px] hidden">AJUSTES</button>
            <button onclick="switchTab('log')" id="tab-log" class="flex-1 py-3 rounded-xl font-bold text-[10px]">LOGS</button>
        </div>

        <div id="view-items" class="space-y-4"></div>

        <div id="view-admin" class="hidden space-y-6">
            <div class="card p-6 border-t-4 border-[#3F51B5]">
                <h3 class="font-bold text-white text-xs mb-4 uppercase italic">Nuevo ArtÃ­culo / Equipo</h3>
                <div class="space-y-3">
                    <input type="text" id="new-name" placeholder="Nombre (ej. Cofias)" class="input-qa">
                    <div class="flex gap-2">
                        <select id="new-cat" class="input-qa w-1/2">
                            <option value="insumos">Insumo</option>
                            <option value="equipos">Equipo</option>
                        </select>
                        <input type="text" id="new-tag" placeholder="ID Equipo" class="input-qa w-1/2">
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="new-stock" placeholder="Stock Inic." class="input-qa w-1/2">
                        <input type="number" id="new-min" placeholder="Stock MÃ­n." class="input-qa w-1/2">
                    </div>
                    <button onclick="addItem()" class="w-full btn-indigo p-3 rounded-xl text-xs">AÃ‘ADIR AL INVENTARIO</button>
                </div>
            </div>

            <div class="card p-6 border-2 border-dashed border-white/10 text-center">
                <h3 class="font-bold text-white text-xs mb-2 uppercase">SincronizaciÃ³n Masiva</h3>
                <input type="file" id="import-file" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleImport(event)">
                <div class="flex gap-2 mt-4">
                    <button onclick="document.getElementById('import-file').click()" class="flex-1 btn-indigo py-3 rounded-xl text-[10px]">IMPORTAR EXCEL</button>
                    <button onclick="exportCSV()" class="flex-1 bg-white/10 py-3 rounded-xl text-[10px] font-bold">EXPORTAR CSV</button>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="font-bold text-white text-xs mb-4 uppercase italic">GestiÃ³n de Usuarios</h3>
                <div id="user-edit-list" class="space-y-2"></div>
            </div>
        </div>

        <div id="view-log" class="hidden">
            <div id="log-container" class="bg-black/20 p-5 rounded-2xl text-[10px] font-mono max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="modal-move" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center p-6 z-50">
        <div class="card p-8 w-full max-w-sm text-center border-t-8 border-indigo-500">
            <h2 id="modal-item-name" class="text-2xl font-black mb-8 uppercase text-white"></h2>
            <div class="flex items-center justify-center gap-6 mb-10">
                <button onclick="adjustTemp(-1)" class="w-16 h-16 rounded-2xl bg-white/5 text-3xl">-</button>
                <input type="number" id="move-qty" value="1" class="w-20 bg-transparent text-white text-5xl font-black text-center outline-none">
                <button onclick="adjustTemp(1)" class="w-16 h-16 rounded-2xl btn-indigo text-3xl shadow-lg">+</button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal()" class="py-4 rounded-xl font-bold bg-white/5 text-xs">CANCELAR</button>
                <button onclick="saveMovement()" class="py-4 rounded-xl font-bold btn-indigo text-xs">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <script>
        // VersiÃ³n 12: ReintegraciÃ³n de Alta de Items y Control Total Admin
        let inventory = JSON.parse(localStorage.getItem('qa_inv_v12')) || [];
        let users = JSON.parse(localStorage.getItem('qa_users_v12')) || ["Operador 1", "Operador 2", "Admin"];
        let logs = JSON.parse(localStorage.getItem('qa_logs_v12')) || [];
        let isAdmin = false, currentUser = "", currentTab = 'insumos', currentStatusFilter = 'all', selectedId = null;

        function init() {
            document.getElementById('user-select').innerHTML = users.map(u => `<option value="${u}">${u}</option>`).join('');
            renderUserEditor();
        }

        function login() {
            const user = document.getElementById('user-select').value;
            if (user === 'Admin' && document.getElementById('admin-pass').value !== 'Qa2025') return alert("Clave Incorrecta");
            currentUser = user; isAdmin = (user === 'Admin');
            document.body.classList.add('app-mode');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('current-user-display').innerText = currentUser;
            document.getElementById('tab-admin').classList.toggle('hidden', !isAdmin);
            addLog(`Acceso: ${currentUser}`);
            switchTab('insumos');
        }

        function addItem() {
            if(!isAdmin) return;
            const name = document.getElementById('new-name').value;
            if(!name) return alert("El nombre es obligatorio");
            
            const newItem = {
                id: Date.now(),
                name: name,
                cat: document.getElementById('new-cat').value,
                tag: document.getElementById('new-tag').value,
                stock: parseInt(document.getElementById('new-stock').value) || 0,
                min: parseInt(document.getElementById('new-min').value) || 0
            };
            
            inventory.push(newItem);
            saveData();
            renderItems();
            addLog(`AÃ±adido nuevo item: ${name}`);
            ['new-name', 'new-tag', 'new-stock', 'new-min'].forEach(id => document.getElementById(id).value = "");
            alert("ArtÃ­culo guardado con Ã©xito");
        }

        function handleImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                if(confirm(`Â¿Sobrescribir con ${jsonData.length} artÃ­culos?`)) {
                    inventory = jsonData.map(row => ({
                        id: Date.now() + Math.random(),
                        name: row.Nombre || row.nombre || "Sin Nombre",
                        cat: (row.CategorÃ­a || row.categoria || "").toLowerCase().includes('equipo') ? 'equipos' : 'insumos',
                        stock: parseInt(row.Stock || row.stock) || 0,
                        min: parseInt(row.MÃ­nimo || row.minimo) || 0,
                        tag: row.ID_Equipo || row.id_equipo || ""
                    }));
                    saveData(); renderItems();
                    addLog("ImportaciÃ³n masiva completada");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportCSV() {
            let csv = "\uFEFFNombre,CategorÃ­a,Stock,MÃ­nimo,ID_Equipo\n";
            inventory.forEach(i => csv += `"${i.name}","${i.cat}",${i.stock},${i.min},"${i.tag}"\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Inventario_QA_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        function renderItems() {
            const container = document.getElementById('view-items'); container.innerHTML = "";
            const query = document.getElementById('search-bar').value.toLowerCase();
            const filtered = inventory.filter(i => {
                if(i.cat !== currentTab) return false;
                const status = i.stock <= i.min ? 'crit' : (i.stock <= i.min * 1.5 ? 'low' : 'ok');
                return (i.name.toLowerCase().includes(query) || i.tag.toLowerCase().includes(query)) && (currentStatusFilter === 'all' || currentStatusFilter === status);
            });
            filtered.forEach(item => {
                const status = item.stock <= item.min ? "status-crit" : (item.stock <= item.min * 1.5 ? "status-low" : "status-ok");
                container.innerHTML += `<div class="card p-5 flex justify-between items-center ${status} fade-in">
                    <div><h4 class="font-bold text-white">${item.name} <span class="text-[10px] opacity-40">${item.tag}</span></h4>
                    <span class="text-3xl font-black">${item.stock}</span> <span class="text-[10px] uppercase opacity-50">En Stock</span></div>
                    <div class="flex flex-col gap-2">
                        <button onclick="openModal(${item.id})" class="btn-indigo px-4 py-2 rounded-xl text-[10px]">REGISTRAR</button>
                        ${isAdmin ? `<button onclick="deleteItem(${item.id})" class="text-[8px] text-rose-400 font-bold uppercase">Eliminar</button>` : ''}
                    </div>
                </div>`;
            });
        }

        function switchTab(t) {
            if(t === 'admin' && !isAdmin) return;
            currentTab = t;
            ['insumos', 'equipos', 'log', 'admin'].forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                if(btn) btn.style.backgroundColor = (tab === t) ? 'var(--driscolls-indigo)' : 'transparent';
            });
            document.getElementById('view-items').classList.toggle('hidden', t === 'log' || t === 'admin');
            document.getElementById('search-section').classList.toggle('hidden', t === 'log' || t === 'admin');
            document.getElementById('view-admin').classList.toggle('hidden', t !== 'admin');
            document.getElementById('view-log').classList.toggle('hidden', t !== 'log');
            if(t === 'log') renderLogs(); else renderItems();
        }

        function deleteItem(id) {
            if(!isAdmin || !confirm("Â¿Eliminar artÃ­culo?")) return;
            inventory = inventory.filter(i => i.id !== id);
            saveData(); renderItems();
        }

        function saveMovement() {
            const qty = parseInt(document.getElementById('move-qty').value);
            const item = inventory.find(i => i.id === selectedId);
            item.stock += qty;
            addLog(`${currentUser}: ${qty > 0 ? '+' : ''}${qty} ${item.name}`);
            saveData(); closeModal(); renderItems();
        }

        function openModal(id) { selectedId = id; const item = inventory.find(i => i.id === id); document.getElementById('modal-item-name').innerText = item.name; document.getElementById('modal-move').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-move').classList.add('hidden'); }
        function adjustTemp(v) { document.getElementById('move-qty').value = parseInt(document.getElementById('move-qty').value) + v; }
        function addLog(m) { logs.unshift(`${new Date().toLocaleString()} | ${m}`); localStorage.setItem('qa_logs_v12', JSON.stringify(logs)); }
        function renderLogs() { document.getElementById('log-container').innerHTML = logs.map(l => `<div class="py-2 border-b border-white/5 opacity-70">${l}</div>`).join(''); }
        function saveData() { localStorage.setItem('qa_inv_v12', JSON.stringify(inventory)); }
        function renderUserEditor() { document.getElementById('user-edit-list').innerHTML = users.map((u, i) => `<input type="text" value="${u}" onchange="users[${i}]=this.value; localStorage.setItem('qa_users_v12', JSON.stringify(users))" class="input-qa text-sm mb-1" ${u==='Admin'?'disabled opacity-40':''}>`).join(''); }
        function setFilter(f) { currentStatusFilter = f; renderItems(); ['all','crit','low','ok'].forEach(id => document.getElementById(`filter-${id}`).classList.toggle('filter-active', id === f)); }
        document.getElementById('user-select').onchange = (e) => { document.getElementById('admin-pass-container').classList.toggle('hidden', e.target.value !== 'Admin'); document.getElementById('admin-pass').value = ""; };
        init();
    </script>
</body>
</html>
