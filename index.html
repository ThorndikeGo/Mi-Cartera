<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PréstamosPersonales</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:#0e0f13; --surface:#16181f; --s2:#1d2029; --border:rgba(255,255,255,0.07);
            --accent:#c9f542; --a2:#42c9f5; --danger:#f5426b; --warn:#f5a742; --text:#f0efe8; --muted:#6b6f7a;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); font-family:'DM Sans', sans-serif; padding-bottom: 50px; }
        
        nav { display:flex; justify-content:space-between; align-items:center; padding:1.5rem; background:rgba(14,15,19,0.8); backdrop-filter:blur(12px); position:sticky; top:0; z-index:100; border-bottom:1px solid var(--border); }
        .logo { font-family:'DM Serif Display', serif; font-size:1.6rem; letter-spacing: -1px; }
        .logo span { color:var(--accent); }
        .nav-btn { background:var(--accent); color:#000; border:none; padding:0.6rem 1.2rem; border-radius:50px; font-weight:700; cursor:pointer; font-size:0.85rem; }

        .container { padding:1.5rem; max-width:600px; margin:0 auto; }
        
        /* Dashboard con Filtro */
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .filter-select { background: var(--s2); color: var(--accent); border: 1px solid var(--border); padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; outline: none; }
        
        .summary { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:2rem; }
        .card { background:var(--surface); padding:1.2rem; border-radius:24px; border:1px solid var(--border); }
        .card-label { font-size:0.6rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px; }
        .card-val { font-family:'DM Serif Display', serif; font-size:1.4rem; }

        /* Lista de Préstamos */
        .loan-card { background:var(--surface); border-radius:24px; border:1px solid var(--border); margin-bottom:1rem; overflow:hidden; }
        .loan-header { padding:1.5rem; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .client-name { font-weight:500; font-size:1.1rem; display:block; }
        .loan-code { font-size: 0.65rem; color: var(--accent); font-weight: 700; margin-bottom: 4px; display: block; }
        .loan-meta { font-size:0.75rem; color:var(--muted); }
        
        .badge { padding:4px 12px; border-radius:50px; font-size:0.65rem; font-weight:700; text-transform:uppercase; }
        .b-active { background:rgba(201,245,66,0.1); color:var(--accent); }
        .b-paid { background:rgba(66,245,170,0.1); color:#42f5aa; }
        .b-overdue { background:rgba(245,66,107,0.1); color:var(--danger); }

        .loan-body { display:none; padding:1.5rem; border-top:1px solid var(--border); background:rgba(255,255,255,0.01); }
        .loan-body.open { display:block; }
        .actions-grid { display:grid; grid-template-columns: 1fr 1fr; gap:0.7rem; }
        .btn { padding:12px; border-radius:15px; border:1px solid var(--border); background:var(--s2); color:var(--text); font-weight:600; font-size:0.8rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }

        /* Modales */
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(10px); z-index:200; align-items:center; justify-content:center; padding:1.5rem; }
        .overlay.open { display:flex; }
        .modal { background:var(--surface); width:100%; max-width:450px; border-radius:30px; padding:2rem; border:1px solid var(--border); max-height:90vh; overflow-y:auto; }
        
        /* Proporciones solicitadas 2/3 y 1/3 */
        .row-split { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; }
        .input-group { position: relative; }
        .input-group span.unit { position: absolute; right: 12px; top: 38px; color: var(--muted); font-weight: 700; font-size: 0.9rem; }

        input, select { width:100%; padding:14px; background:var(--s2); border:1px solid var(--border); color:#fff; border-radius:15px; margin-top:5px; font-family:inherit; outline: none; }
        .fg { margin-bottom: 1.2rem; }

        .prog-track { background:var(--s2); height:12px; border-radius:20px; margin:20px 0 10px 0; overflow:hidden; }
        .prog-fill { height:100%; background:var(--accent); transition: width 0.8s ease; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Préstamos<span>Personales</span></div>
        <button class="nav-btn" onclick="openModal()">+ Nuevo</button>
    </nav>

    <div class="container">
        <div class="dash-header">
            <span class="card-label">Resumen de Cartera</span>
            <select class="filter-select" id="timeFilter" onchange="render()">
                <option value="today">Hoy</option>
                <option value="week">Esta Semana</option>
                <option value="month" selected>Este Mes</option>
                <option value="year">Este Año</option>
                <option value="all">Todo el tiempo</option>
            </select>
        </div>

        <div class="summary">
            <div class="card"><div class="card-label">Colocación</div><div class="card-val" id="sCol">0</div></div>
            <div class="card"><div class="card-label">Recaudación</div><div class="card-val" id="sRec">0</div></div>
            <div class="card"><div class="card-label">Utilidad Real</div><div class="card-val" id="sUtil" style="color:var(--accent)">0</div></div>
            <div class="card"><div class="card-label">Por Cobrar</div><div class="card-val" id="sPend">0</div></div>
        </div>

        <div id="grid"></div>
    </div>

    <div class="overlay" id="modal">
        <div class="modal">
            <h2 style="font-family:'DM Serif Display'; text-align:center; margin-bottom:1.5rem;">Registro de Crédito</h2>
            <div class="fg"><label class="card-label">Nombre del cliente</label><input type="text" id="fName"></div>
            
            <div class="row-split">
                <div class="fg"><label class="card-label">Monto del préstamo</label><input type="number" id="fAmt" oninput="calcDate()"></div>
                <div class="fg input-group">
                    <label class="card-label">Tasa de interés</label>
                    <input type="number" id="fInt" value="40">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="fg"><label class="card-label">WhatsApp</label><input type="tel" id="fTel"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div class="fg"><label class="card-label">Fecha Inicio</label><input type="date" id="fDate" onchange="calcDate()"></div>
                <div class="fg"><label class="card-label">Vencimiento</label><input type="date" id="fDue"></div>
            </div>
            
            <button class="nav-btn" style="width:100%; padding:15px; margin-top:10px;" onclick="save()">CREAR PRÉSTAMO</button>
            <button class="btn" style="width:100%; margin-top:10px; border:none;" onclick="closeAll()">Cerrar</button>
        </div>
    </div>

    <div class="overlay" id="exModal"><div class="modal" id="exContent"></div></div>

    <script>
        let loans = JSON.parse(localStorage.getItem('pp_data_v3')) || [];
        let opens = new Set();

        const fmt = n => '$' + Number(n).toLocaleString('es-CO');
        const tod = () => new Date().toISOString().split('T')[0];

        // Generador de Código Alfanumérico PP-X4Z
        function genCode() {
            const chars = 'ABCDEFGHJKL
    
