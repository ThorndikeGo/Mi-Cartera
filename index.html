<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PréstamosPersonales</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:#0e0f13; --surface:#16181f; --s2:#1d2029; --border:rgba(255,255,255,0.07);
            --accent:#c9f542; --a2:#42c9f5; --danger:#f5426b; --warn:#f5a742; --text:#f0efe8; --muted:#6b6f7a;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); font-family:'DM Sans', sans-serif; padding-bottom: 50px; overflow-x: hidden; }
        
        nav { display:flex; justify-content:space-between; align-items:center; padding:1.5rem; background:rgba(14,15,19,0.8); backdrop-filter:blur(12px); position:sticky; top:0; z-index:100; border-bottom:1px solid var(--border); }
        .logo { font-family:'DM Serif Display', serif; font-size:1.6rem; letter-spacing: -1px; }
        .logo span { color:var(--accent); }
        .nav-btn { background:var(--accent); color:#000; border:none; padding:0.6rem 1.2rem; border-radius:50px; font-weight:700; cursor:pointer; font-size:0.85rem; }

        .container { padding:1.5rem; max-width:600px; margin:0 auto; }
        
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .filter-actions { display: flex; gap: 8px; align-items: center; }
        .filter-select { background: var(--s2); color: var(--accent); border: 1px solid var(--border); padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; outline: none; }
        .btn-excel { background: transparent; border: 1px solid var(--border); color: var(--muted); padding: 5px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-excel:hover { color: var(--text); border-color: var(--text); }

        .summary { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:2rem; }
        .card { background:var(--surface); padding:1.2rem; border-radius:24px; border:1px solid var(--border); }
        .card-label { font-size:0.6rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px; }
        .card-val { font-family:'DM Serif Display', serif; font-size:1.4rem; transition: 0.3s; }

        .loan-card { background:var(--surface); border-radius:24px; border:1px solid var(--border); margin-bottom:1rem; overflow:hidden; }
        .loan-header { padding:1.5rem; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .client-name { font-weight:500; font-size:1.1rem; display:block; }
        .loan-code { font-size: 0.65rem; color: var(--accent); font-weight: 700; margin-bottom: 4px; display: block; }
        .loan-meta { font-size:0.75rem; color:var(--muted); }
        
        .badge { padding:4px 12px; border-radius:50px; font-size:0.65rem; font-weight:700; text-transform:uppercase; }
        .b-active { background:rgba(201,245,66,0.1); color:var(--accent); }
        .b-paid { background:rgba(66,245,170,0.1); color:#42f5aa; }
        .b-overdue { background:rgba(245,66,107,0.1); color:var(--danger); }

        .loan-body { display:none; padding:1.5rem; border-top:1px solid var(--border); background:rgba(255,255,255,0.01); }
        .loan-body.open { display:block; }
        .actions-grid { display:grid; grid-template-columns: 1fr 1fr; gap:0.7rem; }
        .btn { padding:12px; border-radius:15px; border:1px solid var(--border); background:var(--s2); color:var(--text); font-weight:600; font-size:0.8rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }

        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(10px); z-index:200; align-items:center; justify-content:center; padding:1.5rem; }
        .overlay.open { display:flex; }
        .modal { background:var(--surface); width:100%; max-width:450px; border-radius:30px; padding:2rem; border:1px solid var(--border); max-height:90vh; overflow-y:auto; }
        
        .row-split { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; }
        .unit-label { position: absolute; right: 12px; bottom: 14px; color: var(--muted); font-weight: 700; pointer-events: none; }

        input, select { width:100%; padding:14px; background:var(--s2); border:1px solid var(--border); color:#fff; border-radius:15px; margin-top:5px; font-family:inherit; outline: none; }
        input:focus { border-color: var(--accent); }
        .fg { margin-bottom: 1.2rem; }

        .prog-track { background:var(--s2); height:12px; border-radius:20px; margin:20px 0 10px 0; overflow:hidden; }
        .prog-fill { height:100%; background:var(--accent); transition: width 0.8s ease; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Préstamos<span>Personales</span></div>
        <button class="nav-btn" onclick="openModal()">+ Nuevo</button>
    </nav>

    <div class="container">
        <div class="dash-header">
            <span class="card-label">Panel de Control</span>
            <div class="filter-actions">
                <button class="btn-excel" onclick="exportExcel()">Excel</button>
                <select class="filter-select" id="timeFilter" onchange="render()">
                    <option value="today">Hoy</option>
                    <option value="week">Esta Semana</option>
                    <option value="month" selected>Este Mes</option>
                    <option value="year">Este Año</option>
                    <option value="all">Todo</option>
                </select>
            </div>
        </div>

        <div class="summary">
            <div class="card"><div class="card-label">Colocación</div><div class="card-val" id="sCol">$0</div></div>
            <div class="card"><div class="card-label">Recaudación</div><div class="card-val" id="sRec">$0</div></div>
            <div class="card"><div class="card-label">Utilidad Real</div><div class="card-val" id="sUtil" style="color:var(--accent)">$0</div></div>
            <div class="card"><div class="card-label">Saldo Pendiente</div><div class="card-val" id="sPend">$0</div></div>
        </div>

        <div id="grid"></div>
    </div>

    <div class="overlay" id="modalOverlay">
        <div class="modal">
            <h2 style="font-family:'DM Serif Display'; text-align:center; margin-bottom:1.5rem;">Registro de préstamo</h2>
            <div class="fg"><label class="card-label">Nombre del cliente</label><input type="text" id="fName"></div>
            <div class="row-split">
                <div class="fg"><label class="card-label">Monto del préstamo</label><input type="number" id="fAmt" oninput="calcDate()"></div>
                <div class="fg">
                    <label class="card-label">Tasa de int.</label>
                    <div style="position:relative">
                        <input type="number" id="fInt" value="40" style="padding-right:30px">
                        <span class="unit-label">%</span>
                    </div>
                </div>
            </div>
            <div class="fg"><label class="card-label">WhatsApp</label><input type="tel" id="fTel" placeholder="Ej: 521..."></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div class="fg"><label class="card-label">Fecha Inicio</label><input type="date" id="fDate" onchange="calcDate()"></div>
                <div class="fg"><label class="card-label">Vencimiento</label><input type="date" id="fDue"></div>
            </div>
            <button class="nav-btn" style="width:100%; padding:18px; margin-top:10px;" onclick="save()">CREAR PRÉSTAMO</button>
            <button class="btn" style="width:100%; margin-top:10px; border:none;" onclick="closeAll()">Cerrar</button>
        </div>
    </div>

    <div class="overlay" id="abonoOverlay">
        <div class="modal">
            <h2 style="font-family:'DM Serif Display'; text-align:center; margin-bottom:1.5rem;">Registrar abono</h2>
            <input type="hidden" id="activeLoanId">
            <div class="fg">
                <label class="card-label">Monto a abonar</label>
                <input type="number" id="abonoMonto" placeholder="$ 0.00">
            </div>
            <button class="nav-btn" style="width:100%; padding:18px; margin-top:10px; background:var(--a2)" onclick="confirmarAbono()">PROCESAR ABONO</button>
            <button class="btn" style="width:100%; margin-top:10px; border:none;" onclick="closeAll()">Cancelar</button>
        </div>
    </div>

    <div class="overlay" id="confirmOverlay">
        <div class="modal" style="text-align:center;">
            <h2 style="font-family:'DM Serif Display'; margin-bottom:1rem;">¿Eliminar registro?</h2>
            <p style="color:var(--muted); font-size:0.9rem; margin-bottom:2rem;">Esta acción borrará el préstamo permanentemente.</p>
            <input type="hidden" id="deleteLoanId">
            <button class="btn" style="width:100%; background:var(--danger); color:white; border:none; padding:15px; margin-bottom:10px;" onclick="confirmarBorrado()">SÍ, ELIMINAR</button>
            <button class="btn" style="width:100%; border:none;" onclick="closeAll()">CANCELAR</button>
        </div>
    </div>

    <div class="overlay" id="exModal"><div class="modal" id="exContent"></div></div>

    <script>
        let loans = JSON.parse(localStorage.getItem('pp_pro_v3')) || [];
        let opens = new Set();
        const fmt = n => '$' + Number(n).toLocaleString('es-CO');
        const tod = () => new Date().toISOString().split('T')[0];

        function genCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let res = '';
            for(let i=0; i<3; i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
            return `PP-${res}`;
        }

        function openModal() {
            document.getElementById('fName').value = "";
            document.getElementById('fAmt').value = "";
            document.getElementById('fTel').value = "";
            document.getElementById('fDate').value = tod();
            calcDate();
            const modal = document.getElementById('modalOverlay');
            modal.style.display = 'flex';
            modal.classList.add('open');
        }

        function closeAll() {
            document.querySelectorAll('.overlay').forEach(o => {
                o.classList.remove('open');
                o.style.display = 'none';
            });
        }

        function calcDate() {
            const start = document.getElementById('fDate').value;
            if(start) {
                let d = new Date(start + 'T00:00:00');
                d.setDate(d.getDate() + 56);
                document.getElementById('fDue').value = d.toISOString().split('T')[0];
            }
        }

        function isInRange(dateStr, range) {
            const d = new Date(dateStr + 'T00:00:00');
            const now = new Date();
            if(range === 'all') return true;
            if(range === 'today') return dateStr === tod();
            const compareDate = new Date();
            if(range === 'week') compareDate.setDate(now.getDate() - now.getDay());
            if(range === 'month') compareDate.setDate(1);
            if(range === 'year') { compareDate.setMonth(0); compareDate.setDate(1); }
            compareDate.setHours(0,0,0,0);
            return d >= compareDate;
        }

        function save() {
            const l = {
                id: Date.now().toString(),
                code: genCode(),
                name: document.getElementById('fName').value,
                amt: Number(document.getElementById('fAmt').value),
                int: Number(document.getElementById('fInt').value),
                tel: document.getElementById('fTel').value,
                date: document.getElementById('fDate').value,
                due: document.getElementById('fDue').value,
                abonos: []
            };
            if(!l.name || !l.amt) return;
            loans.push(l);
            sync();
            closeAll();
        }

        function add(id) {
            document.getElementById('activeLoanId').value = id;
            document.getElementById('abonoMonto').value = "";
            const modal = document.getElementById('abonoOverlay');
            modal.style.display = 'flex';
            modal.classList.add('open');
        }

        function confirmarAbono() {
            const id = document.getElementById('activeLoanId').value;
            const monto = document.getElementById('abonoMonto').value;
            if(monto && monto > 0) {
                loans.find(x => x.id === id).abonos.push({amount:Number(monto), date:tod()});
                sync();
                closeAll();
            }
        }

        function del(id) {
            document.getElementById('deleteLoanId').value = id;
            const modal = document.getElementById('confirmOverlay');
            modal.style.display = 'flex';
            modal.classList.add('open');
        }

        function confirmarBorrado() {
            const id = document.getElementById('deleteLoanId').value;
            loans = loans.filter(x => x.id !== id);
            sync();
            closeAll();
        }

        function getS(l) {
            const total = l.amt * (1 + (l.int/100));
            const pagado = l.abonos.reduce((s,a)=> s + Number(a.amount), 0);
            const pendiente = Math.max(0, total - pagado);
            const diff = Math.ceil((new Date(l.due + 'T00:00:00') - new Date(tod() + 'T00:00:00')) / (1000*60*60*24));
            const util = pagado > l.amt ? pagado - l.amt : 0;
            return { total, pagado, pendiente, diff, util, status: pendiente < 1 ? 'paid' : (diff < 0 ? 'overdue' : 'active') };
        }

        function render() {
            const grid = document.getElementById('grid');
            const filter = document.getElementById('timeFilter').value;
            let tCol = 0, tRec = 0, tUtil = 0, tPend = 0;
            
            grid.innerHTML = loans.sort((a,b)=>b.id-a.id).map(l => {
                const s = getS(l);
                if(isInRange(l.date, filter)) tCol += l.amt;
                l.abonos.forEach(a => { if(isInRange(a.date, filter)) tRec += Number(a.amount); });
                tUtil += s.util;
                tPend += s.pendiente;

                return `
                <div class="loan-card" style="${s.status === 'overdue' ? 'border-color:var(--danger)' : ''}">
                    <div class="loan-header" onclick="toggle('${l.id}')">
                        <div>
                            <span class="loan-code">${l.code}</span>
                            <span class="client-name">${l.name}</span>
                            <span class="loan-meta">Inicio: ${l.date} • Saldo: ${fmt(s.pendiente)}</span>
                        </div>
                        <span class="badge b-${s.status}">${s.status==='paid'?'Pagado':(s.diff < 0 ? 'Mora' : s.diff+'d')}</span>
                    </div>
                    <div class="loan-body ${opens.has(l.id)?'open':''}">
                        <div class="actions-grid">
                            <button class="btn" style="color:#25D366; border-color:#25D366" onclick="wa('${l.id}')">WhatsApp</button>
                            <button class="btn" onclick="add('${l.id}')">Abonar</button>
                            <button class="btn" onclick="view('${l.id}')">Extracto</button>
                            <button class="btn" onclick="del('${l.id}')" style="color:var(--danger)">Borrar</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('sCol').textContent = fmt(tCol);
            document.getElementById('sRec').textContent = fmt(tRec);
            document.getElementById('sUtil').textContent = fmt(tUtil);
            document.getElementById('sPend').textContent = fmt(tPend);
        }

        function view(id) {
            const l = loans.find(x=>x.id===id);
            const s = getS(l);
            const pct = (s.pagado / s.total) * 100;
            const ex = document.getElementById('exModal');
            document.getElementById('exContent').innerHTML = `
                <h2 style="font-family:'DM Serif Display'; text-align:center; margin-bottom:0.5rem;">Extracto</h2>
                <p style="text-align:center; font-size:0.7rem; color:var(--accent); font-weight:700; margin-bottom:1.5rem;">CÓDIGO: ${l.code}</p>
                <div style="font-size:0.9rem; line-height:1.8; margin-bottom:1rem;">
                    <div style="display:flex; justify-content:space-between;"><span>Cliente:</span><b>${l.name}</b></div>
                    <div style="display:flex; justify-content:space-between;"><span>Monto del préstamo:</span><b>${fmt(l.amt)}</b></div>
                    <div style="display:flex; justify-content:space-between;"><span>Intereses generados:</span><b>${fmt(s.total - l.amt)}</b></div>
                </div>
                <div class="prog-track"><div class="prog-fill" style="width:${pct}%"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:700; margin-bottom:1.5rem;">
                    <span style="color:var(--a2)">ABONADO: ${fmt(s.pagado)}</span>
                    <span style="color:var(--danger)">PENDIENTE: ${fmt(s.pendiente)}</span>
                </div>
                <div style="border-top:1px solid var(--border); padding-top:1rem; max-height:120px; overflow-y:auto;">
                    <p class="card-label" style="margin-bottom:10px">Lista de Abonos</p>
                    ${l.abonos.map(a => `<div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:6px;"><span>${a.date}</span><b>${fmt(a.amount)}</b></div>`).join('')}
                    ${l.abonos.length === 0 ? '<p style="font-size:0.75rem; color:var(--muted)">Sin abonos registrados</p>' : ''}
                </div>
                <button class="nav-btn" style="width:100%; margin-top:1.5rem;" onclick="closeAll()">CERRAR</button>
            `;
            ex.style.display = 'flex';
            ex.classList.add('open');
        }

        function wa(id) {
            const l = loans.find(x=>x.id===id);
            const s = getS(l);
            window.open(`https://wa.me/${l.tel}?text=Hola ${l.name}, el saldo actual de tu préstamo ${l.code} es de ${fmt(s.pendiente)}.`);
        }

        function toggle(id) { opens.has(id)?opens.delete(id):opens.add(id); render(); }
        function sync() { localStorage.setItem('pp_pro_v3', JSON.stringify(loans)); render(); }
        
        function exportExcel() {
            let csv = "Código,Cliente,Monto Préstamo,Tasa %,Total con Interés,Pagado,Pendiente,Estado\n";
            loans.forEach(l => {
                const s = getS(l);
                csv += `${l.code},${l.name},${l.amt},${l.int}%,${s.total},${s.pagado},${s.pendiente},${s.status}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `Reporte_Prestamos_${tod()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        render();
    </script>
</body>
</html>
